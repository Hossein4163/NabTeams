# عملیات و هاردنینگ NabTeams

این راهنما نحوهٔ اجرای دو فاز پایانی هاردنینگ (امنیت و آمادگی عملیاتی) را برای تیم‌های DevOps و پشتیبانی تشریح می‌کند.

> ادمین سامانه می‌تواند وضعیت انجام هر آیتم را از طریق داشبورد `/dashboard/admin/operations` ثبت و لینک مستندات مرتبط (گزارش ZAP، خروجی k6، سیاست حریم خصوصی و ...) را ضمیمه کند. پس از اتمام هر گام، مقدار «وضعیت» را روی «تکمیل شده» قرار دهید تا تاریخ تکمیل در سیستم ذخیره شود.

## 1. فاز امنیتی

1. **اجرای اسکن امنیتی API**
   - اسکریپت `ops/security/zap-baseline.sh` را در برابر محیط staging اجرا کنید.
   - در صورت فعال بودن حالت توسعه (هدرهای دیباگ)، مقدار `DEBUG_MODE=1` را به اسکریپت بدهید تا احراز هویت شبیه‌سازی شود.
   - گزارش تولید شده را در پوشهٔ `artifacts/security` نگه‌داری کنید و موارد High/Medium را قبل از انتشار رفع کنید.
2. **بررسی هدرهای امنیتی**
   - از ابزارهایی مانند [securityheaders.com](https://securityheaders.com) استفاده کنید و مطمئن شوید مقادیر `Content-Security-Policy`, `X-Content-Type-Options`, `Permissions-Policy`, `Referrer-Policy` و `X-Frame-Options` در پاسخ‌های API و فرانت‌اند حضور دارند.
3. **بازبینی محدودیت محتوا**
   - در Swagger پیام‌هایی با طول بیش از ۲۰۰۰ نویسه ارسال کنید تا مطمئن شوید API خطای 400 بازمی‌گرداند.
   - برای چت پشتیبانی، درخواست بیش از ۱۵۰۰ نویسه باید مسدود شود.
4. **کنترل دسترسی**
   - حساب کاربری بدون نقش ادمین نباید به مسیرهای `/api/appeals/admin`، `/api/knowledge-base` (POST/DELETE) و `/health/ready` دسترسی داشته باشد.

## 2. فاز آمادگی عملیاتی

1. **مانیتورینگ و متریک‌ها**
   - اندپوینت `/metrics` (Prometheus) را به سامانهٔ مانیتورینگ متصل کنید و هشدارهایی برای `moderation_failures_total` و زمان متوسط `moderation_duration_ms` بیش از 750ms تعریف نمایید.
   - Health check های `/health/live` و `/health/ready` را در Load Balancer ثبت کنید.
2. **لاگینگ و ردیابی**
   - ویژگی HttpLogging را در محیط staging فعال کنید و سطح آن را روی `Information` بگذارید تا مسیرهای حساس شناسایی شوند.
   - لاگ‌های خطای Gemini را پایش کنید تا در صورت بروز Circuit Breaker سریعاً اقدام شود.
3. **آموزش اپراتورها**
   - سناریوی خطای Gemini (قطع ارتباط) را تمرین کنید: Queue پیام‌ها باید در حالت Rule-based قرار گیرد و اپراتورها از طریق داشبورد گزارش شوند.
   - پاسخ به اعتراض (Appeal) را با دو کاربر تست کنید تا فرآیند تایید/رد برای تیم پشتیبانی روشن باشد.
4. **تست بار**
   - اسکریپت `ops/load-tests/chat-smoke.js` را اجرا و نتایج (RPS، تأخیر) را در Runbook ذخیره کنید.
   - در صورت افزایش تأخیر میانگین بیش از 800ms، مقیاس‌دهی افقی برای سرویس وب API پیشنهاد می‌شود.

## 3. پیکربندی یکپارچه‌سازی‌ها و فضای ذخیره‌سازی

1. **ثبت کلیدهای تولیدی**
   - در محیط تولیدی، مقادیر JSON هر سرویس را در متغیرهای `INTEGRATIONS__GEMINI`, `INTEGRATIONS__PAYMENT_IDPAY`, `INTEGRATIONS__EMAIL_SMTP`, `INTEGRATIONS__SMS_KAVENEGAR` قرار دهید تا حین راه‌اندازی در پایگاه‌داده ذخیره و فعال شوند.
   - پس از بالا آمدن سرویس، به عنوان ادمین وارد `/dashboard/admin/integrations` شوید و صحت فعال بودن رکوردها و کلیدها را بررسی کنید. در صورت نیاز از گزینهٔ «تنظیم جدید» برای Override دستی استفاده کنید.
2. **فضای ذخیره‌سازی مدارک**
   - مسیر ذخیره‌سازی پیش‌فرض در سرویس `LocalRegistrationDocumentStorage` روی `wwwroot/uploads/registrations` است. برای استقرار ابری مسیر جدید (مانند S3 یا NAS) را در تنظیم `Registration__StoragePath` (یا مقداردهی در فایل تنظیمات) مشخص و در صورت استفاده از CDN/فضای خارجی، آدرس پابلیک فایل‌ها را از طریق `Registration__PublicBaseUrl` تعیین کنید یا سرویس را با پیاده‌سازی دلخواه جایگزین نمایید.
   - دسترسی خواندن برای سرویس وب و دسترسی نوشتن محدود (Least Privilege) را تنظیم کنید و سیاست حذف دوره‌ای فایل‌های قدیمی را در Job جداگانه پیاده‌سازی نمایید.
3. **دسترسی سرویس‌های پیامک/ایمیل**
   - آدرس‌های IP سرویس بک‌اند را در لیست سفید ارائه‌دهندگان پیامک/ایمیل ثبت کنید و محدودیت نرخ ارسال را مطابق SLA تنظیم نمایید.
   - یک ارسال آزمایشی (ایمیل و پیامک) انجام دهید و لاگ نتیجه را در داشبورد مانیتورینگ بررسی کنید.
4. **حریم خصوصی و انطباق**
   - سند سیاست حریم خصوصی شامل نحوهٔ ذخیره مدارک، مدت نگه‌داری و دسترسی تیم داوری را تدوین کرده و لینک آن را در صفحهٔ ثبت‌نام قرار دهید.
   - در صورتی که داده‌ها در فضای ابری خارجی ذخیره می‌شوند، بندهای مربوط به قوانین داخلی (مانند قانون صیانت داده) را رعایت کنید.

## چک‌لیست انتشار

- [ ] نتایج اسکن امنیتی بدون مورد High باز است.
- [ ] هشدارهای Prometheus برای متریک‌های moderation فعال هستند.
- [ ] حداقل یک نوبت تست سناریوهای اعتراض و قطع سرویس AI انجام شده است.
- [ ] اپراتورها به آخرین نسخهٔ این سند دسترسی دارند.
- [ ] متغیرهای `INTEGRATIONS__*` مقداردهی و صحت آن‌ها در داشبورد ادمین بررسی شده است.
- [ ] فضای ذخیره‌سازی مدارک و دسترسی سرویس‌های پیامک/ایمیل مطابق استانداردهای امنیتی پیکربندی شده‌اند.
- [ ] سیاست حریم خصوصی منتشر و برای کاربران قابل مشاهده است.
