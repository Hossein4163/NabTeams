# عملیات و هاردنینگ NabTeams

این راهنما نحوهٔ اجرای دو فاز پایانی هاردنینگ (امنیت و آمادگی عملیاتی) را برای تیم‌های DevOps و پشتیبانی تشریح می‌کند.

> **یادداشت وضعیت (محیط آزمایشی AIC)**
>
> به دلیل محدودیت‌های محیط فعلی (نبود دسترسی به خوشه staging، سرویس Prometheus و قابلیت اجرای Docker)، اجرای واقعی سناریوهای امنیتی و عملیاتی زیر انجام نشده است. دستورالعمل‌های موجود همچنان معتبرند، اما پیش از علامت زدن چک‌لیست انتشار باید در محیط سازمانی اجرا و نتایج در همین سند ثبت شوند. برای راحتی تیم‌های عملیاتی، گام‌های پیشنهادی در بخش‌های بعدی با جزئیات بیشتری مستندسازی شده‌اند.

## 1. فاز امنیتی

1. **اجرای اسکن امنیتی API**
   - اسکریپت `ops/security/zap-baseline.sh` را در برابر محیط staging اجرا کنید.
   - در صورت فعال بودن حالت توسعه (هدرهای دیباگ)، مقدار `DEBUG_MODE=1` را به اسکریپت بدهید تا احراز هویت شبیه‌سازی شود.
   - گزارش تولید شده را در پوشهٔ `artifacts/security` نگه‌داری کنید و موارد High/Medium را قبل از انتشار رفع کنید.
   - اگر دسترسی Docker روی Runner فعلی محدود است، هماهنگی با تیم زیرساخت برای اجرای کانتینر `owasp/zap2docker-stable` در یک محیط مجاز یا اجرای دستی اسکریپت روی لپ‌تاپ سازمانی دارای Docker Desktop الزامی است.
2. **بررسی هدرهای امنیتی**
   - از ابزارهایی مانند [securityheaders.com](https://securityheaders.com) استفاده کنید و مطمئن شوید مقادیر `Content-Security-Policy`, `X-Content-Type-Options`, `Permissions-Policy`, `Referrer-Policy` و `X-Frame-Options` در پاسخ‌های API و فرانت‌اند حضور دارند.
3. **بازبینی محدودیت محتوا**
   - در Swagger پیام‌هایی با طول بیش از ۲۰۰۰ نویسه ارسال کنید تا مطمئن شوید API خطای 400 بازمی‌گرداند.
   - برای چت پشتیبانی، درخواست بیش از ۱۵۰۰ نویسه باید مسدود شود.
4. **کنترل دسترسی**
   - حساب کاربری بدون نقش ادمین نباید به مسیرهای `/api/appeals/admin`، `/api/knowledge-base` (POST/DELETE) و `/health/ready` دسترسی داشته باشد.

## 2. فاز آمادگی عملیاتی

1. **مانیتورینگ و متریک‌ها**
   - اندپوینت `/metrics` (Prometheus) را به سامانهٔ مانیتورینگ متصل کنید و هشدارهایی برای `moderation_failures_total` و زمان متوسط `moderation_duration_ms` بیش از 750ms تعریف نمایید.
   - Health check های `/health/live` و `/health/ready` را در Load Balancer ثبت کنید.
   - نمونه کانفیگ پیشنهادی Prometheus:
     ```yaml
     - alert: NabTeamsModerationFailures
       expr: increase(moderation_failures_total[5m]) > 0
       for: 10m
       labels:
         severity: warning
       annotations:
         summary: افزایش خطای ماژول تعدیل محتوا
         description: مقدار "moderation_failures_total" در ۵ دقیقه گذشته افزایش یافته است.
     - alert: NabTeamsModerationLatencyHigh
       expr: histogram_quantile(0.95, rate(moderation_duration_ms_bucket[5m])) > 0.75
       for: 15m
       labels:
         severity: critical
       annotations:
         summary: افزایش تأخیر پردازش پیام‌ها
         description: صدک ۹۵ مدت‌زمان تعدیل محتوا بیش از ۷۵۰ میلی‌ثانیه شده است.
     ```
2. **لاگینگ و ردیابی**
   - ویژگی HttpLogging را در محیط staging فعال کنید و سطح آن را روی `Information` بگذارید تا مسیرهای حساس شناسایی شوند.
   - لاگ‌های خطای Gemini را پایش کنید تا در صورت بروز Circuit Breaker سریعاً اقدام شود.
3. **آموزش اپراتورها**
   - سناریوی خطای Gemini (قطع ارتباط) را تمرین کنید: Queue پیام‌ها باید در حالت Rule-based قرار گیرد و اپراتورها از طریق داشبورد گزارش شوند.
   - پاسخ به اعتراض (Appeal) را با دو کاربر تست کنید تا فرآیند تایید/رد برای تیم پشتیبانی روشن باشد.
   - پس از هر تمرین، جدول گزارش در انتهای سند را به‌روزرسانی کنید (تاریخ اجرا، مسئول شیفت، نتیجه و اقدام اصلاحی).
4. **تست بار**
   - اسکریپت `ops/load-tests/chat-smoke.js` را اجرا و نتایج (RPS، تأخیر) را در Runbook ذخیره کنید.
   - در صورت افزایش تأخیر میانگین بیش از 800ms، مقیاس‌دهی افقی برای سرویس وب API پیشنهاد می‌شود.
   - اگر دسترسی به ابزار k6 یا محیط اجرای تست بار محدود است، با تیم SRE هماهنگ کنید تا سناریو روی Runner مشترک اجرا و خروجی JSON/HTML در `artifacts/load-tests` بایگانی شود.
5. **مدیریت فضای ذخیره‌سازی مدارک**
   - اطمینان حاصل کنید مقدارهای `FileStorage__RootPath` و `FileStorage__PublicBaseUrl` با محیط استقرار هماهنگ هستند (برای مثال مسیر شبکه‌ای اشتراکی یا باکت S3).
   - در شروع هر شیفت عملیاتی، سلامت دسترسی را با یک درخواست نمونه بررسی کنید: `curl -I "$BASE_URL/uploads/sample.pdf"` باید وضعیت 200 برگرداند.
   - مانیتورینگ ظرفیت دیسک/باکت را فعال کنید و در صورت نزدیک شدن به 80٪ ظرفیت، سیاست پاکسازی یا آرشیو را اجرا کنید.

## چک‌لیست انتشار

- [ ] نتایج اسکن امنیتی بدون مورد High باز است.
- [ ] هشدارهای Prometheus برای متریک‌های moderation فعال هستند.
- [ ] حداقل یک نوبت تست سناریوهای اعتراض و قطع سرویس AI انجام شده است.
- [ ] مسیر ذخیره‌سازی مدارک (`FileStorage__RootPath`) و لینک عمومی (`FileStorage__PublicBaseUrl`) در محیط مقصد بررسی و تست شده است.
- [ ] اپراتورها به آخرین نسخهٔ این سند دسترسی دارند.

### جدول گزارش تمرین عملیات

| تاریخ | سناریو | مسئول | نتیجه | اقدامات اصلاحی |
|-------|--------|--------|-------|-----------------|
| _در انتظار اجرا_ | Gemini قطع ارتباط |  |  |  |
| _در انتظار اجرا_ | رسیدگی به اعتراض |  |  |  |
| _در انتظار اجرا_ | تست بار chat-smoke |  |  |  |
